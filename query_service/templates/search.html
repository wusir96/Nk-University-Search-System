<!DOCTYPE html>
<html>
<head>
    <title>å—å¼€æœç´¢å¼•æ“</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f8f9fa; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .user-bar { text-align: right; margin-bottom: 20px; padding: 10px; background: #e9ecef; border-radius: 5px; font-size: 14px; }
        .user-bar a { color: #007bff; text-decoration: none; margin: 0 8px; }
        .user-bar a:hover { text-decoration: underline; }
        .search-container { position: relative; margin: 40px 0; }
        .search-box { width: 100%; padding: 15px; font-size: 18px; border: 2px solid #ddd; border-radius: 25px; box-sizing: border-box; }
        .search-box:focus { outline: none; border-color: #007bff; }
        .search-btn { background: #007bff; color: white; padding: 15px 30px; border: none; border-radius: 25px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .search-btn:hover { background: #0056b3; }
        
        /* æœç´¢å»ºè®®æ ·å¼ */
        .suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-top: none; border-radius: 0 0 10px 10px; max-height: 300px; overflow-y: auto; z-index: 1000; display: none; }
        .suggestion-item { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .suggestion-item:hover { background: #f8f9fa; }
        .suggestion-item:last-child { border-bottom: none; }
        
        /* æ¨èåŒºåŸŸæ ·å¼ */
        .recommendations { margin-top: 30px; }
        .rec-section { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .rec-title { font-weight: bold; color: #333; margin-bottom: 10px; }
        .rec-item { display: inline-block; margin: 5px; padding: 5px 10px; background: white; border: 1px solid #ddd; border-radius: 15px; font-size: 14px; }
        .rec-item a { color: #007bff; text-decoration: none; }
        .rec-item a:hover { text-decoration: underline; }
        
        .navigation { text-align: center; margin-top: 30px; }
        .navigation a { color: #007bff; text-decoration: none; margin: 0 15px; }
        h1 { text-align: center; color: #333; margin-bottom: 10px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç”¨æˆ·çŠ¶æ€æ  -->
        <div class="user-bar">
            {% if session.user_id %}
                ğŸ‘¤ {{ session.username }} ({{ session.role }}) |
                <a href="/profile">ä¸ªäººä¸­å¿ƒ</a> |
                <a href="/recommendations">ä¸ªæ€§åŒ–æ¨è</a> |
                <a href="/logout">é€€å‡º</a>
            {% else %}
                <a href="/login">ç™»å½•</a> |
                <a href="/register">æ³¨å†Œ</a>
            {% endif %}
        </div>

        <h1>ğŸ” å—å¼€æœç´¢å¼•æ“</h1>
        <p class="subtitle">ä¸ºæ‚¨æä¾›å—å¼€æ ¡å†…èµ„æºçš„æ™ºèƒ½æœç´¢æœåŠ¡</p>

        <!-- æœç´¢è¡¨å• -->
        <form action="/search" method="GET">
            <div class="search-container">
                <input type="text" name="q" class="search-box" id="searchInput" 
                       placeholder="è¾“å…¥å…³é”®è¯æœç´¢..." 
                       value="{{ request.args.get('q', '') }}"
                       autocomplete="off">
                <div class="suggestions" id="suggestions"></div>
            </div>
            <div style="text-align: center;">
                <button type="submit" class="search-btn">ğŸ” æœç´¢</button>
            </div>
        </form>

        <!-- ä¸ªæ€§åŒ–æ¨èåŒºåŸŸ -->
        {% if session.user_id %}
        <div class="recommendations" id="personalizedRec">
            <!-- è¿™é‡Œä¼šé€šè¿‡AJAXåŠ è½½ä¸ªæ€§åŒ–æ¨è -->
        </div>
        {% else %}
        <!-- æœªç™»å½•ç”¨æˆ·æ˜¾ç¤ºçƒ­é—¨æŸ¥è¯¢ -->
        <div class="recommendations">
            <div class="rec-section">
                <div class="rec-title">ğŸ”¥ çƒ­é—¨æœç´¢</div>
                <div id="trendingQueries">
                    <!-- é€šè¿‡AJAXåŠ è½½ -->
                </div>
            </div>
        </div>
        {% endif %}

        <!-- æœç´¢ç¤ºä¾‹ -->
        <div class="rec-section">
            <div class="rec-title">ğŸ’¡ æœç´¢ç¤ºä¾‹</div>
            <div class="rec-item"><a href="/search?q=å—å¼€å¤§å­¦">å—å¼€å¤§å­¦</a></div>
            <div class="rec-item"><a href="/search?q=æ´»åŠ¨ site:news.nankai.edu.cn">ç«™å†…æœç´¢</a></div>
            <div class="rec-item"><a href="/search?q=  "å¼€å­¦å…¸ç¤¼" ">"çŸ­è¯­æœç´¢"</a></div>
            <div class="rec-item"><a href="/search?q=è®¡ç®—*">é€šé…æœç´¢</a></div>
            <div class="rec-item"><a href="/search?q=ç« ç¨‹ filetype:pdf">æ–‡æ¡£æœç´¢</a></div>
        </div>

        <!-- å¯¼èˆªé“¾æ¥ -->
        <div class="navigation">
            <a href="/demo">ğŸ¯ åŠŸèƒ½æ¼”ç¤º</a> |
            <a href="/logs">ğŸ“ æŸ¥è¯¢æ—¥å¿—</a> |
            <a href="/click-stats">ğŸ“Š ç‚¹å‡»ç»Ÿè®¡</a>
        </div>
    </div>

    <script>
        // æœç´¢å»ºè®®åŠŸèƒ½
        const searchInput = document.getElementById('searchInput');
        const suggestions = document.getElementById('suggestions');
        let suggestTimeout;

        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            clearTimeout(suggestTimeout);
            
            if (query.length < 2) {
                suggestions.style.display = 'none';
                return;
            }

            suggestTimeout = setTimeout(() => {
                fetch(`/api/search-suggestions?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        showSuggestions(data.suggestions);
                    })
                    .catch(error => console.error('Error:', error));
            }, 300);
        });

        function showSuggestions(suggestionList) {
            suggestions.innerHTML = '';
            
            if (suggestionList.length === 0) {
                suggestions.style.display = 'none';
                return;
            }

            suggestionList.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = suggestion;
                div.addEventListener('click', () => {
                    searchInput.value = suggestion;
                    suggestions.style.display = 'none';
                    // è‡ªåŠ¨æäº¤æœç´¢
                    searchInput.closest('form').submit();
                });
                suggestions.appendChild(div);
            });

            suggestions.style.display = 'block';
        }

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹éšè—å»ºè®®
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.style.display = 'none';
            }
        });

        // åŠ è½½ä¸ªæ€§åŒ–æ¨è
        {% if session.user_id %}
        fetch('/api/personalized-recommendations')
            .then(response => response.json())
            .then(data => {
                showPersonalizedRecommendations(data);
            })
            .catch(error => console.error('Error loading recommendations:', error));
        {% else %}
        // åŠ è½½çƒ­é—¨æŸ¥è¯¢
        fetch('/api/trending-queries')
            .then(response => response.json())
            .then(data => {
                showTrendingQueries(data);
            })
            .catch(error => console.error('Error loading trending queries:', error));
        {% endif %}

        function showPersonalizedRecommendations(data) {
            const container = document.getElementById('personalizedRec');
            let html = '';

            if (data.recent_searches && data.recent_searches.length > 0) {
                html += '<div class="rec-section"><div class="rec-title">ğŸ•’ æœ€è¿‘æœç´¢</div>';
                data.recent_searches.forEach(query => {
                    html += `<div class="rec-item"><a href="/search?q=${encodeURIComponent(query)}">${query}</a></div>`;
                });
                html += '</div>';
            }

            if (data.related_queries && data.related_queries.length > 0) {
                html += '<div class="rec-section"><div class="rec-title">ğŸ”— ç›¸å…³æ¨è</div>';
                data.related_queries.forEach(query => {
                    html += `<div class="rec-item"><a href="/search?q=${encodeURIComponent(query)}">${query}</a></div>`;
                });
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function showTrendingQueries(data) {
            const container = document.getElementById('trendingQueries');
            let html = '';
            
            data.forEach(item => {
                html += `<div class="rec-item"><a href="/search?q=${encodeURIComponent(item.query)}">${item.query}</a> <small>(${item.frequency})</small></div>`;
            });
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>